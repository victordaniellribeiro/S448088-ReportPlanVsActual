<!DOCTYPE html>
<html>
<head>
    <title>S448088-ReportPlanVsActual</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_release:void 0,_iterations:{},items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project ID:",e);var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releaseComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(t){var a=t.getRecord();this._releaseId=a.get("ObjectID"),this._releaseName=t.getRecord().get("Name"),this._release=t.getRecord(),this._loadIterations(e)},select:function(t,a){var r=a[0];this._releaseId=r.get("ObjectID"),this._releaseName=t.getRecord().get("Name"),this._release=t.getRecord(),this._loadIterations(e)},scope:this}});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this.down("#header").add([t])},_loadIterations:function(e){this.myMask.show(),this._iterations={};var t=this._release;console.log("loading iterations:",e,this._release);var a=Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseStartDate"),operator:">="}),r=(Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseDate"),operator:"<="}),Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseStartDate"),operator:">="}),Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseDate"),operator:"<="})),o=a.and(r),n=this;Ext.create("Rally.data.wsapi.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+e},autoLoad:!0,model:"Iteration",fetch:["Name","ObjectID","StartDate","EndDate","PlannedVelocity"],filters:o,sorters:[{property:"StartDate",direction:"ASC"}],limit:1/0,listeners:{load:function(t,a,r){_.each(a,function(e){var t=e.get("PlannedVelocity")||0;n._iterations[e.get("Name")]&&(t+=n._iterations[e.get("Name")].PlannedVelocity),n._iterations[e.get("Name")]={_ref:e.get("_ref"),Name:e.get("Name"),StartDate:e.get("StartDate"),EndDate:e.get("EndDate"),PlannedVelocity:t,PlanEstimate:0,ActualVelocity:0,ActualBurndown:0,PlannedBurndown:0,IsFuture:""}},this),n._iterations.Release={_ref:"",Name:"Release",StartDate:"",EndDate:"",Resources:"",PlanEstimate:"",ActualVelocity:"",ActualBurndown:0,PlannedBurndown:0,IsFuture:""},n._loadArtifacts(e)}},scope:this})},_loadArtifacts:function(e){var t=this._release;console.log("loading artifacts:",e,this._release);var a=Ext.create("Rally.data.QueryFilter",{property:"Iteration.StartDate",value:t.get("ReleaseStartDate"),operator:">="}),r=(Ext.create("Rally.data.QueryFilter",{property:"Iteration.StartDate",value:t.get("ReleaseDate"),operator:"<="}),Ext.create("Rally.data.QueryFilter",{property:"Iteration.EndDate",value:t.get("ReleaseStartDate"),operator:">="}),Ext.create("Rally.data.QueryFilter",{property:"Iteration.EndDate",value:t.get("ReleaseDate"),operator:"<="})),o=a.and(r),n=this;Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+e},autoLoad:!0,models:["Defect","HierarchicalRequirement","TestSet"],fetch:["FormattedID","Name","ObjectID","Iteration","PlanEstimate","ScheduleState","Type"],filters:o,limit:1/0,listeners:{load:function(e,t,a){_.each(t,function(e){e.get("PlanEstimate")}),n._aggregateData(t)}},scope:this})},_aggregateData:function(e){var t=0,a=e;_.each(a,function(e){var a=e.get("PlanEstimate")||0;this._iterations[e.get("Iteration").Name].PlanEstimate+=a,t+=a,"Accepted"!==e.get("ScheduleState")&&"Ready to Ship"!==e.get("ScheduleState")||(this._iterations[e.get("Iteration").Name].ActualVelocity+=a)},this),this._aggregateBurndown(t)},_aggregateBurndown:function(e){var t,a,r,o,n,l=new Date,i=1;_.each(this._iterations,function(s){1===i?(t=e,a=e,r=s.EndDate>=l):"Release"===s.Name?r?(t-=o,a-=o):(t-=n,a-=o):r?(t-=o,a-=o,r=!0):(t-=n,a-=o,r=!1),r=s.EndDate>=l,o=s.PlannedVelocity,n=s.ActualVelocity,this._iterations[s.Name].ActualBurndown=t,this._iterations[s.Name].PlannedBurndown=a,this._iterations[s.Name].IsFuture=r,i++},this),this._showTable(e)},_showTable:function(e){var t=[];_.each(this._iterations,function(e){t.push({Name:e.Name,StartDate:e.StartDate,EndDate:e.EndDate,PlannedVelocity:e.PlannedVelocity,PlanEstimate:e.PlanEstimate,ActualVelocity:e.ActualVelocity,ActualBurndown:e.ActualBurndown,PlannedBurndown:e.PlannedBurndown,IsFuture:e.IsFuture})},this);var a=Ext.create("Ext.data.JsonStore",{fields:["Name","StartDate","EndDate","PlannedVelocity","PlanEstimate","ActualVelocity","ActualBurndown","PlannedBurndown","IsFuture"]});a.loadData(t);var r=Ext.create("Ext.grid.Panel",{width:880,viewConfig:{stripeRows:!0,enableTextSelection:!0},store:a,columns:[{text:"Iteration Name",flex:1,sortable:!0,dataIndex:"Name"},{text:"Start Date",flex:1,format:"Y/m/d",xtype:"datecolumn",sortable:!0,dataIndex:"StartDate"},{text:"End Date",flex:1,format:"Y/m/d",xtype:"datecolumn",sortable:!0,dataIndex:"EndDate"},{text:"Plan Estimate",flex:1,sortable:!0,dataIndex:"PlanEstimate"},{text:"Actual Velocity",flex:1,sortable:!0,dataIndex:"ActualVelocity"},{text:"Planned Velocity",flex:1,sortable:!0,dataIndex:"PlannedVelocity"},{text:"Actual Burndown",flex:1,sortable:!0,dataIndex:"ActualBurndown"},{text:"Planned Burndown",flex:1,sortable:!0,dataIndex:"PlannedBurndown"}]});this.down("#bodyContainer").removeAll(!0),this.down("#bodyContainer").add(r),this.myMask.hide()}});

            Rally.launchApp('CustomApp', {
                name:"S448088-ReportPlanVsActual",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
