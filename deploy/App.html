<!DOCTYPE html>
<html>
<head>
    <title>S448088-ReportPlanVsActual</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_release:void 0,_iterations:{},items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project ID:",e);var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releaseComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(t){var a=t.getRecord();this._releaseId=a.get("ObjectID"),this._releaseName=t.getRecord().get("Name"),this._release=t.getRecord(),this._loadIterations(e)},select:function(t,a){var o=a[0];this._releaseId=o.get("ObjectID"),this._releaseName=t.getRecord().get("Name"),this._release=t.getRecord(),this._loadIterations(e)},scope:this}});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this.down("#header").add([t])},_loadIterations:function(e){this.myMask.show(),this._iterations={};var t=this._release;console.log("loading iterations:",e,this._release);var a=Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseStartDate"),operator:">="}),o=(Ext.create("Rally.data.QueryFilter",{property:"StartDate",value:t.get("ReleaseDate"),operator:"<="}),Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseStartDate"),operator:">="}),Ext.create("Rally.data.QueryFilter",{property:"EndDate",value:t.get("ReleaseDate"),operator:"<="})),r=a.and(o),n=this;Ext.create("Rally.data.wsapi.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+e},autoLoad:!0,model:"Iteration",fetch:["Name","ObjectID","StartDate","EndDate","PlannedVelocity"],filters:r,sorters:[{property:"StartDate",direction:"ASC"}],limit:1/0,listeners:{load:function(t,a,o){_.each(a,function(e){var t=e.get("PlannedVelocity")||0;n._iterations[e.get("Name")]&&(t+=n._iterations[e.get("Name")].PlannedVelocity),n._iterations[e.get("Name")]={_ref:e.get("_ref"),Name:e.get("Name"),StartDate:e.get("StartDate"),EndDate:e.get("EndDate"),PlannedVelocity:t,SlottedVelocity:0,ActualVelocity:0,PlannedVelocityBurndown:0,SlottedBurndown:0,ActualBurndown:0,IsFuture:""}},this),n._iterations.Release={_ref:"",Name:"Release",StartDate:"",EndDate:"",Resources:"",SlottedVelocity:"",ActualVelocity:"",PlannedVelocityBurndown:0,ActualBurndown:0,IsFuture:""},n._loadArtifacts(e)}},scope:this})},_loadArtifacts:function(e){var t=this._release;console.log("loading artifacts:",e,this._release);var a=Ext.create("Rally.data.QueryFilter",{property:"Iteration.StartDate",value:t.get("ReleaseStartDate"),operator:">="}),o=(Ext.create("Rally.data.QueryFilter",{property:"Iteration.StartDate",value:t.get("ReleaseDate"),operator:"<="}),Ext.create("Rally.data.QueryFilter",{property:"Iteration.EndDate",value:t.get("ReleaseStartDate"),operator:">="}),Ext.create("Rally.data.QueryFilter",{property:"Iteration.EndDate",value:t.get("ReleaseDate"),operator:"<="})),r=a.and(o),n=this;Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+e},autoLoad:!0,models:["Defect","HierarchicalRequirement","TestSet"],fetch:["FormattedID","Name","ObjectID","Iteration","PlanEstimate","ScheduleState","Type"],filters:r,limit:1/0,listeners:{load:function(e,t,a){_.each(t,function(e){e.get("PlanEstimate")}),n._aggregateData(t)}},scope:this})},_aggregateData:function(e){var t=0,a=e;_.each(a,function(e){var a=e.get("PlanEstimate")||0;this._iterations[e.get("Iteration").Name].SlottedVelocity+=a,t+=a,"Accepted"!==e.get("ScheduleState")&&"Ready to Ship"!==e.get("ScheduleState")||(this._iterations[e.get("Iteration").Name].ActualVelocity+=a)},this),this._aggregateBurndown(t)},_aggregateBurndown:function(e){var t,a,o,r,n,l,i,d=new Date,s=1;_.each(this._iterations,function(c){1===s?(t=e,o=e,a=e,r=c.EndDate>=d):"Release"===c.Name?r?(t-=n,o-=n,a-=i):(t-=l,o-=n,a-=i):r?(t-=n,o-=n,a-=i,r=!0):(t-=l,o-=n,a-=i,r=!1),r=c.EndDate>=d,n=c.PlannedVelocity,l=c.ActualVelocity,i=c.SlottedVelocity,this._iterations[c.Name].PlannedVelocityBurndown=o,this._iterations[c.Name].SlottedBurndown=a,this._iterations[c.Name].ActualBurndown=t,this._iterations[c.Name].IsFuture=r,s++},this),this._showTable(e)},_showTable:function(e){var t=[];_.each(this._iterations,function(e){t.push({Name:e.Name,StartDate:e.StartDate,EndDate:e.EndDate,PlannedVelocity:e.PlannedVelocity,SlottedVelocity:e.SlottedVelocity,ActualVelocity:e.ActualVelocity,PlannedVelocityBurndown:e.PlannedVelocityBurndown,SlottedBurndown:e.SlottedBurndown,ActualBurndown:e.ActualBurndown,IsFuture:e.IsFuture})},this);var a=Ext.create("Ext.data.JsonStore",{fields:["Name","StartDate","EndDate","PlannedVelocity","SlottedVelocity","ActualVelocity","PlannedVelocityBurndown","SlottedBurndown","ActualBurndown","IsFuture"]});a.loadData(t);var o=Ext.create("Ext.grid.Panel",{width:1280,viewConfig:{stripeRows:!0,enableTextSelection:!0},store:a,columns:[{text:"Iteration Name",flex:1,sortable:!0,dataIndex:"Name"},{text:"Start Date",flex:1,format:"Y/m/d",xtype:"datecolumn",sortable:!0,dataIndex:"StartDate"},{text:"End Date",flex:1,format:"Y/m/d",xtype:"datecolumn",sortable:!0,dataIndex:"EndDate"},{text:"Planned Velocity",flex:1,sortable:!0,dataIndex:"PlannedVelocity"},{text:"SlottedVelocity",flex:1,sortable:!0,dataIndex:"SlottedVelocity"},{text:"Actual Velocity",flex:1,sortable:!0,dataIndex:"ActualVelocity"},{text:"Planned Velocity Burndown",flex:1,sortable:!0,dataIndex:"PlannedVelocityBurndown"},{text:"Actual Burndown",flex:1,sortable:!0,dataIndex:"ActualBurndown"},{text:"Slotted Burndown",flex:1,sortable:!0,dataIndex:"SlottedBurndown"}]});this.down("#bodyContainer").removeAll(!0),this.down("#bodyContainer").add(o),this._showGraph(),this.myMask.hide()},_loadGraphData:function(){var e=[];return _.each(this._iterations,function(t){"Release"==t.Name&&console.log("minimum:",t.PlannedVelocityBurndown),e.push({Name:t.Name,PlannedVelocityBurndown:t.PlannedVelocityBurndown,SlottedBurndown:t.SlottedBurndown,ActualBurndown:t.ActualBurndown,Zeros:0})},this),Ext.create("Ext.data.JsonStore",{fields:["Name","PlannedVelocityBurndown","SlottedBurndown","ActualBurndown","Zeros"],data:e})},_showGraph:function(){var e=this._loadGraphData(),t=this._iterations.Release.PlannedVelocityBurndown,a=Ext.create("Ext.chart.Chart",{width:1280,height:410,padding:"10 0 0 0",style:"background : #fff;",animate:!0,shadow:!1,store:e,insetPadding:40,legend:{position:"right",boxStrokeWidth:0,labelFont:"12px Helvetica"},axes:[{type:"numeric",fields:["PlannedVelocityBurndown","SlottedBurndown","ActualBurndown"],position:"left",grid:!0,minimum:t,label:{renderer:function(e){return e}}},{type:"category",fields:"Name",position:"bottom",grid:!0,label:{rotate:{degrees:-45}}}],items:[{type:"text",text:"Release Plan Estimate:1000",font:"12px Helvetica",x:12,y:390}],series:[{type:"line",axis:"left",title:"Planned Velocity Burndown",xField:"Name",yField:"PlannedVelocityBurndown",style:{"stroke-dasharray":[9,5],"stroke-width":1,opacity:1},markerConfig:{radius:2},highlight:{fill:"#000",radius:2,"stroke-width":2,stroke:"#fff"},tips:{trackMouse:!0,style:"background: #FFF",height:20,renderer:function(e,t){this.setTitle(e.get("Name")+": "+e.get("PlannedVelocityBurndown"))}}},{type:"line",axis:"left",title:"Actual Burndown",xField:"Name",yField:"ActualBurndown",style:{"stroke-width":1},markerConfig:{radius:2},highlight:{fill:"#000",radius:2,"stroke-width":2,stroke:"#fff"},tips:{trackMouse:!0,style:"background: #FFF",height:20,renderer:function(e,t){this.setTitle(e.get("Name")+": "+e.get("ActualBurndown"))}}},{type:"line",axis:"left",title:"",xField:"Name",yField:"Zeros",showMarkers:!1,style:{stroke:"#000",opacity:1},markerConfig:{radius:1},highlight:{fill:"#000",radius:1,"stroke-width":1,stroke:"#fff"}}]});this.down("#bodyContainer").add(a)}});

            Rally.launchApp('CustomApp', {
                name:"S448088-ReportPlanVsActual",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
